import groovy.sql.Sql

pipeline {
    agent any
    stages {
       
		stage('Create final tables'){
			 steps{
                script{
					
					
					sqlconnection().execute'''
							CREATE TABLE departments_final (
								department_id INT NOT NULL PRIMARY KEY,
								department_name VARCHAR (30) NOT NULL,
								location VARCHAR (100) DEFAULT NULL);
							'''
						

					sqlconnection().execute'''
							CREATE TABLE jobs_final (
								job_id INT NOT NULL PRIMARY KEY,
								job_title VARCHAR (35) NOT NULL,
								min_salary DECIMAL (8, 2) DEFAULT NULL,
								max_salary DECIMAL (8, 2) DEFAULT NULL);
							'''
						
						
					sqlconnection().execute'''
						CREATE TABLE employees_final (
							employee_id INT NOT NULL PRIMARY KEY,
							name_prefix VARCHAR (20) DEFAULT NULL,
							first_name VARCHAR (20) DEFAULT NULL,
							last_name VARCHAR (25) NOT NULL,
							gender VARCHAR (20) DEFAULT NULL,
							email VARCHAR (100) NOT NULL,
							father_name VARCHAR (100) DEFAULT NULL,
							mother_name VARCHAR (100) DEFAULT NULL,
							dob DATE DEFAULT NULL,
							age DECIMAL (8, 2) DEFAULT NULL,
							weight DECIMAL (8, 2) DEFAULT NULL,
							hire_date DATE NOT NULL,
							age_in_company DECIMAL (8, 2) DEFAULT NULL,
							salary DECIMAL (8, 2) DEFAULT NULL,
							SSN VARCHAR (20) DEFAULT NULL,
							phone_number VARCHAR (20) DEFAULT NULL,
							country VARCHAR (20) DEFAULT NULL,
							city VARCHAR (20) DEFAULT NULL,
							state VARCHAR (20) DEFAULT NULL,
							region VARCHAR (20) DEFAULT NULL,
							zip_code INT DEFAULT NULL,
							username VARCHAR (100) DEFAULT NULL,
							passcode VARCHAR (100) DEFAULT NULL,
							job_id INT NOT NULL,
							manager_id INT DEFAULT NULL,
							department_id INT DEFAULT NULL,
							quarter_of_joining VARCHAR (20) DEFAULT NULL,
							FOREIGN KEY (job_id) REFERENCES jobs_final (job_id),
							FOREIGN KEY (department_id) REFERENCES departments_final (department_id),
							FOREIGN KEY (manager_id) REFERENCES employees_final (employee_id)
					);
						'''
		
					}
				}
		}
		stage('Load data into final tables'){
			 steps{
                script{
	
					sqlconnection().execute'''
						INSERT INTO departments_final
						SELECT * FROM departments
					'''
					sqlconnection().execute'''
						INSERT INTO jobs_final
						SELECT * FROM jobs
					'''
					sqlconnection().execute'''
						INSERT INTO employees_final
						SELECT * FROM staff_u;
					'''
					
		}}}
		
		}
	
}

@NonCPS
    def sqlconnection() {
        String URL = "jdbc:teradata://wbtlabserver.teradata.com/KH255051";
        String username = "KH255051";
        String password = "${dbc_password}";
        String driver= "com.teradata.jdbc.TeraDriver"
        
        echo "Building connection"
        def sqlconn = Sql.newInstance(URL, username, password, driver)
        return sqlconn
    }
